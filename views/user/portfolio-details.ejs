<%- include('../partials/header') %>

<div class="container-xxl py-5">
    <div class="container">
        <div class="text-center mx-auto wow fadeInUp" data-wow-delay="0.1s" style="max-width: 800px;">
            <h1 class="display-6 mb-2"><%= portfolio.name %></h1>
            <p class="mb-5">Manage your holdings and track your performance.</p>
        </div>

        <!-- Portfolio Summary -->
        <div class="row g-4 justify-content-center mb-5 wow fadeInUp" data-wow-delay="0.2s">
            <div class="col-lg-3 col-md-6">
                <div class="card border-0 shadow text-center h-100">
                    <div class="card-body">
                        <p class="text-muted mb-1">Total Value</p>
                        <h4 class="mb-0">$<%= portfolio.totalValue.toFixed(2) %></h4>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card border-0 shadow text-center h-100">
                    <div class="card-body">
                        <p class="text-muted mb-1">Total Profit/Loss</p>
                        <h4 class="mb-0 text-<%= portfolio.profitLoss >= 0 ? 'success' : 'danger' %>">$<%= portfolio.profitLoss.toFixed(2) %></h4>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card border-0 shadow text-center h-100">
                    <div class="card-body">
                        <p class="text-muted mb-1">Total Return</p>
                        <h4 class="mb-0 text-<%= portfolio.profitLossPercent >= 0 ? 'success' : 'danger' %>"><%= portfolio.profitLossPercent.toFixed(2) %>%</h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Stock to Portfolio Form -->
        <div class="row justify-content-center mb-5">
            <div class="col-lg-8 wow fadeInUp" data-wow-delay="0.3s">
                <div class="card border-0 shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Add Stock to Portfolio</h5>
                    </div>
                    <div class="card-body">
                        <form action="/user/portfolios/<%= portfolio.id %>/stocks" method="POST">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="stock_id" class="form-label">Stock</label>
                                    <select class="form-select" id="stock_id" name="stock_id" required>
                                        <option selected disabled value="">Choose...</option>
                                        <% allStocks.forEach(stock => { %>
                                            <option value="<%= stock.id %>"><%= stock.symbol %> - <%= stock.name %></option>
                                        <% }); %>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="quantity" class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="quantity" name="quantity" step="any" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="purchase_price" class="form-label">Purchase Price</label>
                                    <input type="number" class="form-control" id="purchase_price" name="purchase_price" step="any" required>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary w-100">Add Stock</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Holdings Table -->
        <div class="row wow fadeInUp" data-wow-delay="0.4s">
            <div class="col-12">
                <div class="card border-0 shadow">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Portfolio Holdings</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Quantity</th>
                                        <th>Purchase Price</th>
                                        <th>Current Price</th>
                                        <th>Total Value</th>
                                        <th>P/L</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (portfolio.stocks && portfolio.stocks.length > 0) { %>
                                        <% portfolio.stocks.forEach(stock => { %>
                                            <% 
                                                const purchasePrice = parseFloat(stock.purchase_price) || 0;
                                                const currentPrice = parseFloat(stock.current_price) || 0;
                                                const quantity = parseFloat(stock.quantity) || 0;
                                                const totalValue = quantity * currentPrice;
                                                const profitLoss = totalValue - (quantity * purchasePrice);
                                            %>
                                            <tr>
                                                <td><strong><%= stock.symbol %></strong></td>
                                                <td><%= quantity %></td>
                                                <td>$<%= purchasePrice.toFixed(2) %></td>
                                                <td>$<%= currentPrice.toFixed(2) %></td>
                                                <td>$<%= totalValue.toFixed(2) %></td>
                                                <td class="text-<%= profitLoss >= 0 ? 'success' : 'danger' %>">
                                                    $<%= profitLoss.toFixed(2) %>
                                                </td>
                                                <td>
                                                    <form action="/user/portfolios/<%= portfolio.id %>/stocks/<%= stock.portfolio_stock_id %>?_method=DELETE" method="POST" onsubmit="return confirm('Are you sure you want to remove this stock?');">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fa fa-trash"></i></button>
                                                    </form>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="7" class="text-center py-4">This portfolio has no holdings. Add a stock above to get started.</td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include('../partials/footer') %>
