<%- include('../partials/header', { title: 'Market Data', activeNav: 'market-data' }) %>

<div class="container-fluid py-5">
    <div class="container py-5">
        <div class="text-center mx-auto mb-5 wow fadeInUp" data-wow-delay="0.1s" style="max-width: 700px;">
            <h1 class="display-5 mb-4">Real-time Market Data</h1>
            <p class="mb-4">Access up-to-the-minute stock prices, market indices, and financial data to make informed investment decisions.</p>
        </div>

        <!-- Selected Stock Context (if symbol provided) -->
        <% if (requestedSymbol) { %>
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert <%= selectedStock ? 'alert-info' : 'alert-warning' %> d-flex justify-content-between align-items-center">
                    <div>
                        <% if (selectedStock) { %>
                            <strong><%= selectedStock.symbol %></strong> â€” <%= selectedStock.company_name || selectedStock.name || '' %>
                            <% if (selectedStock.current_price) { %>
                                &nbsp;| Price: $<%= Number(selectedStock.current_price).toFixed(2) %>
                            <% } %>
                        <% } else { %>
                            No stock found for symbol "<%= requestedSymbol %>". Showing general market data.
                        <% } %>
                    </div>
                    <div class="ms-3">
                        <% if (selectedStock) { %>
                            <a class="btn btn-sm btn-outline-primary" href="/stock/<%= selectedStock.symbol %>">View Details</a>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
        <% } %>

        <!-- Market Indices -->
        <div class="row g-4 mb-5">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <h4 class="mb-0">Market Indices</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Value</th>
                                        <th>Change</th>
                                        <th>Last Updated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (indices && indices.length) { %>
                                        <% indices.forEach(index => { %>
                                            <tr>
                                                <td><strong><%= index.name %></strong></td>
                                                <td><%= Number(index.value).toFixed(2) %></td>
                                                <td class="<%= (Number(index.change_percent) || 0) >= 0 ? 'text-success' : 'text-danger' %>">
                                                    <%= (Number(index.change_percent) || 0) >= 0 ? '+' : '' %><%= (Number(index.change_percent) || 0).toFixed(2) %>%
                                                </td>
                                                <td><%= index.last_updated ? new Date(index.last_updated).toLocaleString() : 'N/A' %></td>
                                            </tr>
                                        <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="4" class="text-center">No market indices data available</td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Stocks -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Top Stocks by Market Cap</h4>
                        <div>
                            <% if (typeof user !== 'undefined' && user) { %>
                                <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#addToWatchlistModal">
                                    <i class="fas fa-plus-circle me-2"></i>Add to Watchlist
                                </button>
                            <% } else { %>
                                <a href="/auth/login" class="btn btn-sm btn-light">
                                    <i class="fas fa-sign-in-alt me-2"></i>Login to Add to Watchlist
                                </a>
                            <% } %>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="table-responsive">
                            <table class="table table-hover" id="stocksTable">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Company</th>
                                        <th>Price</th>
                                        <th>% Change</th>
                                        <th>Market Cap</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (topStocks && topStocks.length > 0) { %>
                                        <% topStocks.forEach(stock => { %>
                                            <tr>
                                                <td><strong><%= stock.symbol %></strong></td>
                                                <td><%= stock.company_name || stock.name || 'N/A' %></td>
                                                <td>$<%= (Number(stock.current_price) || 0).toFixed(2) %></td>
                                                <td class="<%= (Number(stock.change_percent) || 0) >= 0 ? 'text-success' : 'text-danger' %>">
                                                    <%= (Number(stock.change_percent) || 0) >= 0 ? '+' : '' %><%= (Number(stock.change_percent) || 0).toFixed(2) %>%
                                                </td>
                                                <td>
                                                    <% const mc = Number(stock.market_cap); %>
                                                    <% if (!Number.isNaN(mc) && mc > 0) { %>
                                                        <% if (mc >= 1e12) { %>
                                                            $<%= (mc/1e12).toFixed(2) %>T
                                                        <% } else if (mc >= 1e9) { %>
                                                            $<%= (mc/1e9).toFixed(2) %>B
                                                        <% } else if (mc >= 1e6) { %>
                                                            $<%= (mc/1e6).toFixed(2) %>M
                                                        <% } else { %>
                                                            $<%= mc.toFixed(2) %>
                                                        <% } %>
                                                    <% } else { %>
                                                        N/A
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <div class="btn-group">
                                                        <a class="btn btn-sm btn-outline-primary" href="/stock/<%= stock.symbol %>">
                                                            <i class="fas fa-chart-line me-1"></i> View
                                                        </a>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="6" class="text-center">No stock data available</td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add to Watchlist Modal -->
<% if (typeof user !== 'undefined' && user) { %>
    <div class="modal fade" id="addToWatchlistModal" tabindex="-1" aria-labelledby="addToWatchlistModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="addToWatchlistModalLabel">Add to Watchlist</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/dashboard/list/add" method="POST" id="addToListForm">
                        <input type="hidden" name="stock_id" id="selectedStockId">
                        <div class="mb-3">
                            <label for="watchlistSelect" class="form-label">Select Watchlist</label>
                            <select class="form-select" id="watchlistSelect" name="watchlist_id" required>
                                <option value="">Select a watchlist</option>
                                <!-- Watchlist options will be populated via AJAX -->
                            </select>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#newWatchlistForm">
                                Create New Watchlist
                            </button>
                            <button type="submit" class="btn btn-primary">Add to Watchlist</button>
                        </div>
                        
                        <div class="collapse mt-3" id="newWatchlistForm">
                            <div class="card card-body">
                                <div class="mb-3">
                                    <label for="newWatchlistName" class="form-label">New Watchlist Name</label>
                                    <input type="text" class="form-control" id="newWatchlistName" name="new_watchlist_name">
                                </div>
                                <button type="button" class="btn btn-success" id="createWatchlistBtn">Create & Add</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
<% } %>

<script>
    // Function to view stock details
    function viewStockDetails(stockId) {
        window.location.href = `/stock/${stockId}`;
    }
    
    // Function to add stock to watchlist
    function addToWatchlist(stockId) {
        document.getElementById('selectedStockId').value = stockId;
        
        // Fetch user's watchlists
        fetch('/dashboard/list/list')
            .then(response => response.json())
            .then(data => {
                const watchlistSelect = document.getElementById('watchlistSelect');
                watchlistSelect.innerHTML = '<option value="">Select a watchlist</option>';
                
                data.forEach(watchlist => {
                    const option = document.createElement('option');
                    option.value = watchlist.id;
                    option.textContent = watchlist.name;
                    watchlistSelect.appendChild(option);
                });
                
                $('#addToWatchlistModal').modal('show');
            })
            .catch(error => {
                console.error('Error fetching watchlists:', error);
                alert('Error loading watchlists. Please try again.');
            });
    }
    
    // Create new watchlist and add stock
    document.getElementById('createWatchlistBtn')?.addEventListener('click', function() {
        const newWatchlistName = document.getElementById('newWatchlistName').value;
        const stockId = document.getElementById('selectedStockId').value;
        
        if (!newWatchlistName) {
            alert('Please enter a name for your watchlist');
            return;
        }
        
        // Create new watchlist
        fetch('/dashboard/list', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name: newWatchlistName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add stock to the newly created watchlist
                fetch('/dashboard/list/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        watchlist_id: data.watchlist_id,
                        stock_id: stockId
                    })
                })
                .then(response => response.json())
                .then(addData => {
                    if (addData.success) {
                        $('#addToWatchlistModal').modal('hide');
                        alert('Stock added to your new watchlist');
                    } else {
                        alert('Error adding stock to watchlist');
                    }
                })
                .catch(error => {
                    console.error('Error adding stock to watchlist:', error);
                    alert('Error adding stock to watchlist');
                });
            } else {
                alert('Error creating watchlist');
            }
        })
        .catch(error => {
            console.error('Error creating watchlist:', error);
            alert('Error creating watchlist');
        });
    });
</script>

<%- include('../partials/footer') %>